# 标题编号逻辑说明

## 修改内容

已检查并修复了标题编号逻辑，确保**同级标题需要连续编号**，同时**子标题在每个父级标题下重新开始编号**。

### 修改的文件

1. **Python版本**: `md2doc-service-python/src/md2doc_mcp/core/template_creator.py`
2. **Java版本**: `md2doc-core/src/main/java/cn/daydayup/dev/md2doc/core/template/DynamicWordDocumentCreator.java`

### 修改后的逻辑

#### 1. 当遇到更高级别的标题时 (`level < lastLevel`)

**情况说明**: 从子标题跳回到父级标题（例如：H3 -> H2, H2 -> H1）

**处理逻辑**:
- 检查是否遇到了新的更高层级标题（通过比较父级标题编号）
- 如果遇到了新的更高层级标题，重置当前级别及其所有子级别的计数器（一级标题除外），当前级别从1开始编号
- 如果还在同一个父级标题下，同级标题应该继续累加（这是修复的关键点）

**示例**:
```
H1: 一、项目概述
    H2: 1、技术架构
        H3: 1）核心组件
        H3: 2）系统流程
    H2: 2、数据分析  ← 从H3跳回H2，但还在同一个H1下，所以H2继续累加为2
```

#### 2. 当进入更深层级时 (`level > lastLevel`)

**情况说明**: 从父标题进入子标题（例如：H1 -> H2, H2 -> H3）

**处理逻辑**:
- 只重置更深级别的计数器
- 当前级别从1开始编号（在新的父级标题下）

**示例**:
```
H1: 一、项目概述
    H2: 1、技术架构  ← 在H1下，H2从1开始
        H3: 1）核心组件  ← 在H2下，H3从1开始
```

#### 3. 当遇到同级标题时 (`level == lastLevel`)

**情况说明**: 连续的相同级别标题

**处理逻辑**:
- 不重置计数器，继续累加

**示例**:
```
H2: 1、技术架构
H2: 2、数据分析  ← 同级H2，继续累加
H2: 3、项目进度  ← 同级H2，继续累加
```

### 编号格式

- **一级标题（H1）**: 一、二、三、...（中文数字）
- **二级标题（H2）**: 1、2、3、...（阿拉伯数字）
- **三级标题（H3）**: 1）、2）、3）、...（阿拉伯数字+右括号）
- **四级标题（H4）**: 1.1.1.1、1.1.1.2、...（点号分隔）
- **五级标题（H5）**: 1）、2）、...（阿拉伯数字+右括号）
- **六级标题（H6）**: 1）、2）、...（阿拉伯数字+右括号）

### 关键特性

1. ✅ **一级标题永远不重置**: 一级标题的计数器始终累加，确保文档级别的连续性
2. ✅ **子标题在父级标题下重新开始**: 每个级别的子标题都会在新的父级标题下重新从1开始编号
3. ✅ **同级标题继续累加**: 相同级别的标题会连续编号

## 测试用例

### 用例1：基本多级标题

**Markdown结构**:
```markdown
# 项目概述
## 技术架构
## 数据分析
# 项目进度
## 开发阶段
## 测试阶段
```

**期望的Word标题编号**:
```
一、项目概述
1、技术架构
2、数据分析
二、项目进度
1、开发阶段
2、测试阶段
```

### 用例2：复杂嵌套

**Markdown结构**:
```markdown
# 第一章
## 第一节
### 第一小节
### 第二小节
## 第二节
### 第一小节
# 第二章
## 第一节
```

**期望的Word标题编号**:
```
一、第一章
1、第一节
1）第一小节
2）第二小节
2、第二节
1）第一小节
二、第二章
1、第一节
```

### 用例3：跳级情况

**Markdown结构**:
```markdown
# 第一章
## 第一节
### 第一小节
## 第二节
```

**期望的Word标题编号**:
```
一、第一章
1、第一节
1）第一小节
2、第二节  ← 从H3跳回H2，H2继续累加
```

## 注意事项

1. 一级标题的计数器永远不会被重置，确保整个文档的连续性
2. **重要修复**：当从子标题跳回到父级标题时，如果父级标题还在同一个更高层级的标题下，则父级标题继续累加（这是本次修复的关键点）
3. 当遇到新的更高层级标题时，当前级别及其子级别的计数器都会重置并重新开始编号
4. 通过记录每个级别的父级标题编号来判断是否遇到了新的更高层级标题

## 修复说明（2025-01-XX）

### 问题描述
二级标题编号期望同级需要连续编号的没有连续编号。例如：
```
# 第一章
## 第一节
### 第一小节
## 第二节  ← 这里应该是2，但之前被错误地重置为1
```

### 修复方案
1. 添加了`parent_levels`字典/Map来记录每个级别的父级标题编号
2. 当从子标题跳回父级标题时，通过比较父级标题编号来判断是否遇到了新的更高层级标题
3. 如果父级标题编号没有变化，说明还在同一个父级标题下，同级标题应该继续累加
4. 只有当遇到新的更高层级标题时，才重置当前级别及其子级别的计数器

### 修复的文件
1. **Python版本**: `md2doc-service-python/src/md2doc_mcp/core/template_creator.py`
   - 添加了`parent_levels`属性
   - 修改了`enter_level`方法的逻辑

2. **Java版本**: `md2doc-core/src/main/java/cn/daydayup/dev/md2doc/core/template/DynamicWordDocumentCreator.java`
   - 添加了`parentLevels` Map
   - 修改了`enterLevel`方法的逻辑

